{% extends 'base.html' %}
{% block content %}
<div class="card" id="journal-root" data-journal-id="{{ journal_id }}">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div>
      <h2 style="margin:0;" id="journal-name">{{ name or 'Journal' }}</h2>
      {% if goal %}<div style="margin-top:4px;color:#555;font-size:0.9em;white-space:pre-line;" id="journal-goal">{{ goal }}</div>{% endif %}
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn" onclick="window.location='/journals'">Back</button>
      <button class="btn" id="toggle-entry-form">Add Entry</button>
      <button class="btn" id="logout-btn">Logout</button>
    </div>
  </div>
  <div id="entry-form-wrapper" style="display:none;">
    <hr style="margin:16px 0 12px;" />
    <form id="new-entry-form" style="margin-bottom:16px;">
      <textarea id="entry-text" class="input" rows="3" placeholder="Write a new entry... (time will be timestamped automatically)"></textarea>
      <div style="display:flex;justify-content:flex-end;margin-top:8px;gap:8px;">
        <button type="button" class="btn" id="cancel-entry">Cancel</button>
        <button type="submit" class="btn primary">Save Entry</button>
      </div>
    </form>
  </div>
  <hr style="margin:16px 0;" />
  <div id="entries-list"></div>
</div>
<script>
  const JOURNAL_ID = '{{ journal_id }}';
  const USER_ID = '{{ user_id }}';
  function esc(str){return (str||'').replace(/[&<>"]'/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}
  let entriesCache = [];
  async function loadEntries(){
    const list = document.getElementById('entries-list');
    list.innerHTML = 'Loading...';
    const res = await fetch(`/api/journal/${USER_ID}/${JOURNAL_ID}/entries`);
    if(!res.ok){ list.innerHTML = '<em>Failed to load entries.</em>'; return; }
    const data = await res.json();
    entriesCache = (data.entries || []).sort((a,b)=> (b._id||'').localeCompare(a._id||''));
    if(entriesCache.length===0){ list.innerHTML = '<em>No entries yet.</em>'; return; }
    list.innerHTML = entriesCache.map(e=>renderEntry(e)).join('');
  }
  function renderEntry(e){
    let created = e.date;
    if (e._id && e._id.length===24){
      const ts = parseInt(e._id.substring(0,8),16)*1000;
      created = new Date(ts).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
    }
    // server text already includes [HH:MM:SS] lines
    return `<div class='entry' data-id='${e._id}' style="border:1px solid #ddd;padding:10px;border-radius:6px;margin-bottom:10px;">
      <div style='display:flex;justify-content:space-between;align-items:center;'>
        <strong style='font-size:0.9em;'>${created}</strong>
        <div style='display:flex;gap:6px;'>
          <button class='btn' onclick="editEntry('${e._id}')">Edit</button>
          <button class='btn' onclick="deleteEntry('${e._id}')" style='color:#c00;'>Delete</button>
        </div>
      </div>
      <div class='entry-text' id='entry-text-${e._id}' style='margin-top:6px;white-space:pre-wrap;font-family:monospace;'>${esc(e.text||'')}</div>
    </div>`;
  }
  document.getElementById('toggle-entry-form').onclick = () => {
    document.getElementById('entry-form-wrapper').style.display = 'block';
    document.getElementById('entry-text').focus();
  };
  document.getElementById('cancel-entry').onclick = () => {
    document.getElementById('entry-form-wrapper').style.display = 'none';
    document.getElementById('entry-text').value='';
  };
  document.getElementById('new-entry-form').onsubmit = async (e)=>{
    e.preventDefault();
    const text = document.getElementById('entry-text').value.trim();
    if(!text) return;
    const now = new Date();
    const today = now.toLocaleDateString('en-US');
    const time = now.toLocaleTimeString('en-US', { hour12: false }); // HH:MM:SS local
    await fetch(`/api/journal/${JOURNAL_ID}/entries`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text, date: today, time }) });
    document.getElementById('entry-text').value='';
    document.getElementById('entry-form-wrapper').style.display='none';
    loadEntries();
  };
  window.editEntry = async (id)=>{
    const node = document.getElementById('entry-text-'+id);
    const current = node.textContent;
    const updated = prompt('Edit full entry text (timestamps preserved if kept):', current);
    if(updated===null) return;
    await fetch(`/api/journal/entry/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text: updated }) });
    loadEntries();
  };
  window.deleteEntry = async (id)=>{
    if(!confirm('Delete this entry?')) return;
    await fetch(`/api/journal/entry/${id}`, { method:'DELETE' });
    loadEntries();
  };
  document.getElementById('logout-btn').onclick = async () => { await fetch('/api/logout',{method:'POST'}); window.location='/login'; };
  loadEntries();
</script>
{% endblock %}
