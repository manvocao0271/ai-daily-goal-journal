{% extends 'base.html' %}
{% block content %}
<div class="card" id="journal-root" data-journal-id="{{ journal_id }}" data-created-at="{{ created_at }}">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;">
    <div style="flex:1;">
      <div id="elapsed" style="font-size:0.8em;color:#666;margin-bottom:4px;">Loading age...</div>
      <h2 style="margin:0;" id="journal-name">{{ name or 'Journal' }}</h2>
      {% if goal %}<div style="margin-top:4px;color:#555;font-size:0.9em;white-space:pre-line;" id="journal-goal">{{ goal }}</div>{% endif %}
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn" onclick="window.location='/journals'">Back</button>
      <button class="btn" id="toggle-entry-form">Add Entry</button>
      <button class="btn" id="logout-btn">Logout</button>
    </div>
  </div>
  <div id="entry-form-wrapper" style="display:none;">
    <hr style="margin:16px 0 12px;" />
    <form id="new-entry-form" style="margin-bottom:16px;">
      <textarea id="entry-text" class="input" rows="3" placeholder="Write a new entry... (time will be timestamped automatically)"></textarea>
      <div style="display:flex;justify-content:flex-end;margin-top:8px;gap:8px;">
        <button type="button" class="btn" id="cancel-entry">Cancel</button>
        <button type="submit" class="btn primary">Save Entry</button>
      </div>
    </form>
  </div>
  <hr style="margin:16px 0;" />
  <div id="entries-list"></div>
  <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
    <button class="btn" id="coach-suggest-btn">Get Coaching Suggestion</button>
  </div>
  <div id="coach-suggestion" style="display:none;margin-top:12px;padding:12px;border:1px solid #cce;border-radius:6px;background:#f3f8ff;white-space:pre-wrap;font-size:0.9em;"></div>
  <div style="margin-top:20px;border-top:1px solid #ddd;padding-top:12px;">
    <h3 style="margin:0 0 8px;font-size:1.05em;">Goal Plan (8 Steps)</h3>
    <div id="plan-controls" style="margin-bottom:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
      <button class="btn" id="generate-plan-btn">Generate / Refresh Plan</button>
    </div>
    <ol id="plan-steps" style="padding-left:20px;margin:0;display:block;list-style:decimal;"></ol>
  </div>
</div>
<!-- Edit Entry Modal -->
<div id="edit-entry-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:1500;">
  <div style="background:#fff;max-width:640px;width:92%;padding:24px;border-radius:10px;box-shadow:0 4px 18px rgba(0,0,0,.25);display:flex;flex-direction:column;max-height:85vh;">
    <h3 style="margin:0 0 4px;">Edit Daily Entry</h3>
    <p style="margin:0 0 12px;font-size:0.85em;color:#555;">Each line is timestamped. Edit text, remove a line, or add a new line (a current time will be auto-filled). The time part stays in [HH:MM:SS] format.</p>
    <div id="edit-lines" style="overflow:auto;border:1px solid #ddd;border-radius:6px;padding:8px;background:#fafafa;margin-bottom:12px;max-height:40vh;"></div>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <button id="add-edit-line" class="btn">Add Line</button>
      <div id="edit-error" style="color:#c00;font-size:0.8em;align-self:center;"></div>
    </div>
    <div style="margin-left:auto;display:flex;gap:10px;">
      <button id="cancel-edit" class="btn">Cancel</button>
      <button id="save-edit" class="btn primary">Save Changes</button>
    </div>
  </div>
</div>
<style>
  .entry-actions { position: relative; }
  .gear-btn { background:transparent;border:none;cursor:pointer;font-size:16px;line-height:1;padding:4px 6px;border-radius:4px; }
  .gear-btn:hover { background:#eee; }
  .entry-menu { position:absolute; top:28px; right:0; background:#fff; border:1px solid #ccc; border-radius:6px; min-width:120px; box-shadow:0 4px 12px rgba(0,0,0,.15); padding:6px 0; display:none; z-index:20; }
  .entry-menu button { width:100%; background:none; border:none; text-align:left; padding:6px 12px; font-size:13px; cursor:pointer; }
  .entry-menu button:hover { background:#f5f5f5; }
  .entry-menu button.delete { color:#c01818; }
  .entry.deleted { opacity:.45; }
</style>
<script>
  const JOURNAL_ID = '{{ journal_id }}';
  const USER_ID = '{{ user_id }}';
  function esc(str){return (str||'').replace(/[&<>"]'/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}
  let entriesCache = [];
  async function loadEntries(){
    const list = document.getElementById('entries-list');
    list.innerHTML = 'Loading...';
    const res = await fetch(`/api/journal/${USER_ID}/${JOURNAL_ID}/entries`);
    if(!res.ok){ list.innerHTML = '<em>Failed to load entries.</em>'; return; }
    const data = await res.json();
    entriesCache = (data.entries || []).sort((a,b)=> (b._id||'').localeCompare(a._id||''));
    if(entriesCache.length===0){ list.innerHTML = '<em>No entries yet.</em>'; return; }
    list.innerHTML = entriesCache.map(e=>renderEntry(e)).join('');
  }
  function renderEntry(e){
    let created = e.date;
    if (e._id && e._id.length===24){
      const ts = parseInt(e._id.substring(0,8),16)*1000;
      created = new Date(ts).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
    }
    const entryId = e._id;
    return `<div class='entry' data-id='${entryId}' style="border:1px solid #ddd;padding:10px 10px 10px 10px;border-radius:6px;margin-bottom:10px;">
      <div style='display:flex;justify-content:space-between;align-items:center;'>
        <strong style='font-size:0.9em;'>${created}</strong>
        <div class='entry-actions'>
          <button class='gear-btn' aria-label='Entry actions' onclick="toggleEntryMenu(event,'${entryId}')">⚙</button>
          <div class='entry-menu' id='menu-${entryId}'>
            <button onclick="openEditEntry('${entryId}')">Edit</button>
            <button class='delete' onclick="confirmDeleteEntry('${entryId}')">Delete</button>
          </div>
        </div>
      </div>
      <div class='entry-text' id='entry-text-${entryId}' style='margin-top:6px;white-space:pre-wrap;font-family:monospace;'>${esc(e.text||'')}</div>
    </div>`;
  }
  window.toggleEntryMenu = (ev,id)=>{
    ev.stopPropagation();
    document.querySelectorAll('.entry-menu').forEach(m=>{ if(m.id!==`menu-${id}`) m.style.display='none'; });
    const menu = document.getElementById('menu-'+id);
    menu.style.display = (menu.style.display==='block') ? 'none' : 'block';
  };
  window.confirmDeleteEntry = async (id)=>{
    const entryDiv = document.querySelector(`.entry[data-id='${id}']`);
    if(entryDiv) entryDiv.classList.add('deleted');
    try {
      const res = await fetch(`/api/journal/entry/${id}`, { method:'DELETE' });
      if(!res.ok){
        if(entryDiv) entryDiv.classList.remove('deleted');
        alert('Delete failed');
        return;
      }
      await loadEntries();
    } catch(e){
      if(entryDiv) entryDiv.classList.remove('deleted');
      alert('Network error');
    }
  };
  document.addEventListener('click', e=>{
    if(!e.target.closest('.entry-actions')){
      document.querySelectorAll('.entry-menu').forEach(m=> m.style.display='none');
    }
  });
  document.getElementById('toggle-entry-form').onclick = () => {
    document.getElementById('entry-form-wrapper').style.display = 'block';
    document.getElementById('entry-text').focus();
  };
  document.getElementById('cancel-entry').onclick = () => {
    document.getElementById('entry-form-wrapper').style.display = 'none';
    document.getElementById('entry-text').value='';
  };
  document.getElementById('new-entry-form').onsubmit = async (e)=>{
    e.preventDefault();
    const text = document.getElementById('entry-text').value.trim();
    if(!text) return;
    const now = new Date();
    const today = now.toLocaleDateString('en-US');
    const time = now.toLocaleTimeString('en-US', { hour12: false }); // HH:MM:SS local
    await fetch(`/api/journal/${JOURNAL_ID}/entries`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text, date: today, time }) });
    document.getElementById('entry-text').value='';
    document.getElementById('entry-form-wrapper').style.display='none';
    loadEntries();
  };
  let editingEntryId = null;
  function openEditEntry(id){
    editingEntryId = id;
    const modal = document.getElementById('edit-entry-modal');
    const container = document.getElementById('edit-lines');
    const entry = entriesCache.find(e=>e._id===id);
    container.innerHTML='';
    if(!entry){return;}
    const lines = (entry.text||'').split(/\n+/).filter(l=>l.trim().length>0);
    lines.forEach(l=>addLineRowFromRaw(l, container));
    if(lines.length===0){ addLineRow(container); }
    modal.style.display='flex';
    setTimeout(()=>{ const first = container.querySelector('input.line-text'); if(first) first.focus(); }, 30);
  }
  function closeEditEntry(){
    document.getElementById('edit-entry-modal').style.display='none';
    document.getElementById('edit-error').textContent='';
    editingEntryId=null;
  }
  function pad(n){return n.toString().padStart(2,'0');}
  function currentTimeStr(){ const d=new Date(); return pad(d.getHours())+':'+pad(d.getMinutes())+':'+pad(d.getSeconds()); }
  function parseLine(raw){
    const m = raw.match(/^\[(\d{2}:\d{2}:\d{2})\]\s?(.*)$/);
    if(m) return {time:m[1], text:m[2]};
    return {time: currentTimeStr(), text: raw};
  }
  function addLineRowFromRaw(raw, container){ const p=parseLine(raw); addLineRow(container, p.time, p.text); }
  function addLineRow(container, timeStr=currentTimeStr(), textStr=''){
    const row=document.createElement('div');
    row.className='edit-line-row';
    row.style="display:flex;gap:6px;align-items:flex-start;margin-bottom:6px;";
    row.innerHTML = `<input class='line-time' value='${timeStr}' style="width:80px;padding:4px;border:1px solid #ccc;border-radius:4px;font-family:monospace;" pattern="\\d{2}:\\d{2}:\\d{2}" title="HH:MM:SS"/>`+
      `<input class='line-text' value="${textStr.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;')}" style="flex:1;padding:4px;border:1px solid #ccc;border-radius:4px;" placeholder="Entry text"/>`+
      `<button type='button' class='btn' style='background:#f3f3f3;' onclick='this.parentElement.remove()'>✕</button>`;
    container.appendChild(row);
  }
  document.getElementById('add-edit-line').onclick = () => addLineRow(document.getElementById('edit-lines'));
  document.getElementById('cancel-edit').onclick = closeEditEntry;
  document.getElementById('edit-entry-modal').addEventListener('click', e=>{ if(e.target.id==='edit-entry-modal') closeEditEntry(); });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape' && editingEntryId) closeEditEntry(); });
  document.getElementById('save-edit').onclick = async ()=>{
    const container = document.getElementById('edit-lines');
    const errorDiv = document.getElementById('edit-error');
    const rows = Array.from(container.querySelectorAll('.edit-line-row'));
    if(rows.length===0){ errorDiv.textContent='At least one line required.'; return; }
    const assembled = [];
    for(const r of rows){
      const tInput = r.querySelector('.line-time');
      const xInput = r.querySelector('.line-text');
      const timeVal = (tInput.value||'').trim();
      const textVal = (xInput.value||'').trim();
      if(!textVal) continue; // skip empty
      if(!/^\d{2}:\d{2}:\d{2}$/.test(timeVal)){ errorDiv.textContent='Invalid time format on a line.'; return; }
      assembled.push(`[${timeVal}] ${textVal}`);
    }
    if(assembled.length===0){ errorDiv.textContent='All lines empty.'; return; }
    await fetch(`/api/journal/entry/${editingEntryId}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text: assembled.join('\n') }) });
    closeEditEntry();
    loadEntries();
  };
  window.editEntry = openEditEntry;
  document.getElementById('logout-btn').onclick = async () => { await fetch('/api/logout',{method:'POST'}); window.location='/login'; };
  loadEntries();
  // Elapsed timer logic
  const createdAtISO = document.getElementById('journal-root').getAttribute('data-created-at');
  function parseISOZ(s){
    // Ensure trailing Z recognized
    try { return new Date(s); } catch(e){ return null; }
  }
  function updateElapsed(){
    if(!createdAtISO) return;
    const start = parseISOZ(createdAtISO);
    if(!start || isNaN(start.getTime())) return;
    const now = new Date();
    let diff = Math.floor((now - start)/1000);
    if(diff < 0) diff = 0; // handle clock skew
    const days = Math.floor(diff/86400); diff -= days*86400;
    const hours = Math.floor(diff/3600); diff -= hours*3600;
    const mins = Math.floor(diff/60);
    const parts = [];
    if(days>0) parts.push(days + (days===1?' day':' days'));
    if(days>0 || hours>0) parts.push(hours + (hours===1?' hr':' hrs'));
    parts.push(mins + (mins===1?' min':' mins'));
    const text = (Math.floor((now-start)/60000) < 1) ? 'Started just now' : 'Started ' + parts.join(', ') + ' ago';
    document.getElementById('elapsed').textContent = text;
  }
  updateElapsed();
  setInterval(updateElapsed, 60*1000);
  const coachBtn = document.getElementById('coach-suggest-btn');
  const coachBox = document.getElementById('coach-suggestion');
  if(coachBtn){
    coachBtn.onclick = async () => {
      coachBtn.disabled = true; coachBtn.textContent = 'Thinking...';
      coachBox.style.display='block';
      coachBox.textContent = 'Generating suggestion...';
      try {
        const res = await fetch('/api/coach/suggest',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({ journal_id: JOURNAL_ID, limit_days: 1 })});
        if(!res.ok){ coachBox.textContent = 'Error: '+res.status; } else { const data = await res.json(); coachBox.textContent = data.suggestion || '(No suggestion)'; }
      } catch(e){ coachBox.textContent = 'Network error.'; }
      coachBtn.disabled = false; coachBtn.textContent = 'Get Coaching Suggestion';
    };
  }
  async function loadPlan(){
    const list = document.getElementById('plan-steps');
    const res = await fetch(`/api/coach/plan/${JOURNAL_ID}`);
    if(!res.ok){ list.innerHTML='<li><em>Failed to load plan.</em></li>'; return; }
    const data = await res.json();
    renderPlan(data.steps||[]);
  }
  function renderPlan(steps){
    const list = document.getElementById('plan-steps');
    if(!steps.length){ list.innerHTML = '<li><em>No plan yet. Generate one.</em></li>'; return; }
    list.innerHTML = steps.map(st=>{
      const checked = st.completed? 'checked' : '';
      return `<li style='margin-bottom:10px;display:flex;align-items:flex-start;gap:8px;'>
        <input type='checkbox' class='plan-step-check' data-step-id='${st.id}' ${checked} style='margin-top:4px;'/>
        <div style='flex:1;'>
          <strong>${escapeHtml(st.title)}</strong><br>
          <span style='color:#444;'>${escapeHtml(st.description)}</span>
          ${st.expected_outcome?`<div style='font-size:0.7em;color:#666;margin-top:2px;'>Outcome: ${escapeHtml(st.expected_outcome)}</div>`:''}
        </div>
      </li>`;
    }).join('');
    // Attach listeners
    list.querySelectorAll('.plan-step-check').forEach(cb=>{
      cb.addEventListener('change', async (e)=>{
        const id = cb.getAttribute('data-step-id');
        const completed = cb.checked;
        try { await fetch(`/api/coach/plan/${JOURNAL_ID}/toggle`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ step_id: id, completed })}); } catch(err){ alert('Update failed'); cb.checked = !completed; }
      });
    });
  }
  document.getElementById('generate-plan-btn').onclick = async ()=>{
    const btn = document.getElementById('generate-plan-btn');
    btn.disabled=true; btn.textContent='Generating...';
    try {
      const res = await fetch('/api/coach/breakdown',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ journal_id: JOURNAL_ID })});
      if(res.ok){ const data = await res.json(); renderPlan(data.steps||[]); }
      else { const txt = await res.text(); alert('Failed to generate plan\n'+txt.slice(0,300)); }
    } catch(e){ alert('Network error: '+e); }
    btn.disabled=false; btn.textContent='Generate / Refresh Plan';
  };
  loadPlan();
</script>
{% endblock %}
