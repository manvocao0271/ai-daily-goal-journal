{% extends 'base.html' %}
{% block content %}
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h2 style="margin:0;">Your Journals</h2>
    <div style="display:flex; gap:8px;">
      <button id="create-journal-btn" class="btn">Create</button>
      <button id="logout-btn" class="btn">Logout</button>
    </div>
  </div>
  <div id="journal-list" style="margin-top:12px;"></div>
</div>
<!-- Modal -->
<div id="create-journal-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);align-items:center;justify-content:center;z-index:1000;">
  <div style="background:#fff;padding:24px;border-radius:8px;min-width:340px;box-shadow:0 2px 8px rgba(0,0,0,0.2);">
    <h3>Create New Journal</h3>
    <form id="create-journal-form">
      <label style="display:block;margin-bottom:12px;">Journal Name:<br><input type="text" id="new-journal-name" class="input" placeholder="e.g. Fitness Progress"></label>
      <label style="display:block;margin-bottom:12px;">Goal / Purpose:<br><textarea id="new-journal-goal" class="input" rows="3" placeholder="Describe the purpose of this journal..."></textarea></label>
      <div style="display:flex;gap:8px;">
        <button type="submit" class="btn primary">Create</button>
        <button type="button" id="cancel-create-journal" class="btn">Cancel</button>
      </div>
    </form>
  </div>
</div>
<script>
  const USER_ID = '{{ user_id }}';
  function esc(str){return (str||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}
  async function loadJournals() {
    const list = document.getElementById('journal-list');
    list.innerHTML = 'Loading...';
    const res = await fetch(`/api/journal/${USER_ID}`);
    if (!res.ok) { list.innerHTML = '<em>Failed to load journals.</em>'; return; }
    const data = await res.json();
    let journals = data.entries || [];
    journals = journals.sort((a,b) => (b._id || '').localeCompare(a._id || ''));
    if (journals.length === 0) { list.innerHTML = '<em>No journals yet.</em>'; return; }
    list.innerHTML = journals.map(j => {
      let created = j.date;
      if (j._id && j._id.length === 24) {
        const ts = parseInt(j._id.substring(0,8), 16) * 1000;
        created = new Date(ts).toLocaleString();
      }
      const goalShort = j.goal ? esc(j.goal.length > 70 ? j.goal.slice(0,67) + 'â€¦' : j.goal) : '';
      return `<div class="journal-item" style="padding:10px 0;border-bottom:1px solid #eee;">
        <strong>${esc(j.name) || created}</strong>
        <span style="float:right;color:#888;font-size:0.85em;">${created}</span>
        ${goalShort ? `<div style=\"margin-top:4px;color:#555;font-size:0.85em;\">${goalShort}</div>`: ''}
      </div>`;
    }).join('');
  }
  document.getElementById('create-journal-btn').onclick = () => {
    document.getElementById('create-journal-modal').style.display = 'flex';
  };
  document.getElementById('cancel-create-journal').onclick = () => {
    document.getElementById('create-journal-modal').style.display = 'none';
  };
  document.getElementById('create-journal-form').onsubmit = async (e) => {
    e.preventDefault();
    const name = document.getElementById('new-journal-name').value.trim();
    const goal = document.getElementById('new-journal-goal').value.trim();
    if (!name) return;
    const date = new Date().toLocaleDateString('en-US');
    await fetch('/api/journal', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: USER_ID, text: '', date, name, goal }) });
    document.getElementById('new-journal-name').value = '';
    document.getElementById('new-journal-goal').value = '';
    document.getElementById('create-journal-modal').style.display = 'none';
    loadJournals();
  };
  document.getElementById('logout-btn').onclick = async () => {
    await fetch('/api/logout', { method:'POST' });
    window.location.href = '/login';
  };
  loadJournals();
</script>
{% endblock %}
